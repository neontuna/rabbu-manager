<div class="page-header">
  <%= link_to listings_path, class: 'btn btn-secondary' do %>
    <span class="glyphicon glyphicon-list-alt"></span>
    All Listings
  <% end %>
  <%= link_to edit_listing_path(@listing), class: 'btn btn-primary' do %>
    <span class="glyphicon glyphicon-pencil"></span>
    Edit
  <% end %>
</div>

<h1 class="mt-3">
  <%= @listing.title %>
  <small class="text-muted"><%= @listing.address %></small>
</h1>

<div class="mt-3">  
  <h4>Devices</h4>
  <% if @listing.devices.any? %>
    <div class="table-responsive">
      <table class="table table-striped table-bordered table-hover">
        <thead>
          <tr>
            <th></th>
            <th>Device Name</th>
            <th>Status</th>
            <th></th>
          </tr>
        </thead>

        <tbody>
          <% @listing.devices.each do |device| %>
            <%= content_tag :tr, id: dom_id(device), class: dom_class(device) do %>
              <td>
                <!-- Being lazy and using bootstrap classes here for color -->
                <% case device.hardware_type %>
                <% when "st_switch" %>
                  <% if device.status == 'on' %>
                    <%= icon('fas', 'lightbulb', class: 'text-warning') %>
                  <% else %>
                    <%= icon('fas', 'lightbulb', class: 'text-muted') %>
                  <% end %>
                <% when "st_lock" %>
                  <% if device.status == 'locked' %>
                    <%= icon('fas', 'lock', class: 'text-success') %>
                  <% else %>
                    <%= icon('fas', 'lock-open', class: 'text-danger') %>
                  <% end %>
                <% when "st_thermostat" %>
                  <% if device.status == 'cooling' %>
                    <%= icon('fas', 'temperature-high', class: 'text-primary') %>
                  <% elsif device.status == 'heating' %>
                    <%= icon('fas', 'temperature-high', class: 'text-danger') %>
                  <% else %>
                    <%= icon('fas', 'temperature-high', class: 'text-muted') %>
                  <% end %>
                <% end %>
              </td>
              <td><%= device.display_name %></td>
              <td><%= device.status %></td>
              <td>
                <% if device.hardware_type == "st_thermostat" %>
                  Mode: <%= device.meta["mode"] %> | 
                  Temperature: <%= device.meta["temperature"] %> Â°F
                <% end %>
              </td>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>

    <%= link_to "Reauthorize with SmartThings to add or remove devices", @smartthings_authorize_url  %> 
  <% else %>
    <%= link_to "Authorize with SmartThings to add devices", @smartthings_authorize_url  %>  
  <% end %>
</div>

<div class="mt-4">
  <h4>Reservations</h4>
  <div class="rm-reservations__create-button btn btn-primary">New Reservation</div>
  <div class="rm-reservations__create-form hidden">
    <%= render 'reservations/form', reservation: @reservation, listing: @listing %>
  </div>
  <div class="rm-reservations__edit-form hidden">
  </div>
  <% if @listing.reservations.any? %>
    <div class="mt-2 table-responsive">
      <table class="table table-striped table-bordered table-hover">
        <thead>
          <tr>
            <th>Start Date</th>
            <th>End Date</th>
            <th></th>
          </tr>
        </thead>

        <tbody>
          <% @listing.reservations.each do |reservation| %>
            <%= content_tag :tr, id: dom_id(reservation), class: dom_class(reservation) do %>
              <td><%= reservation.start_date %></td>
              <td><%= reservation.end_date %></td>
              <td>
                <%= link_to "Edit", edit_listing_reservation_path(@listing, reservation), remote: true  %>
              </td>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    No reservations for listing.
  <% end %>
</div>